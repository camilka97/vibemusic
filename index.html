<script>
let audioContext;
let analyser;
let microphone;
let dataArray;
let running = false;
let lastVibration = 0;

const button = document.getElementById("toggle");
const status = document.getElementById("status");

button.onclick = async () => {
  if (!running) {
    await start();
  } else {
    stop();
  }
};

async function start() {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();

  // IMPORTANT pour iOS
  await audioContext.resume();

  analyser = audioContext.createAnalyser();
  analyser.fftSize = 256;

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  microphone = audioContext.createMediaStreamSource(stream);
  microphone.connect(analyser);

  dataArray = new Uint8Array(analyser.frequencyBinCount);

  running = true;
  button.textContent = "Arrêter";
  button.className = "off";
  status.textContent = "Écoute en cours…";

  loop();
}

function stop() {
  running = false;
  button.textContent = "Démarrer";
  button.className = "on";
  status.textContent = "Arrêté";
}

function loop() {
  if (!running) return;

  analyser.getByteTimeDomainData(dataArray);

  let sum = 0;
  for (let i = 0; i < dataArray.length; i++) {
    const v = (dataArray[i] - 128) / 128;
    sum += v * v;
  }

  const rms = Math.sqrt(sum / dataArray.length);
  const now = Date.now();

  // Seuil plus bas + vibrations plus espacées (clé pour iOS)
  if (rms > 0.03 && now - lastVibration > 300) {
    navigator.vibrate([100]);
    lastVibration = now;
  }

  requestAnimationFrame(loop);
}
</script>
